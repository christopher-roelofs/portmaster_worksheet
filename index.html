<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PortMaster Database</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" integrity="sha512-t4GWSVZO1eC8BM339Xd7Uphw5s17a86tIZIj8qRxhnKub6WoyhnrxeCIMeAqBPgdZGlCcG2PrZjMc+Wr78+5Xg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Bootstrap Icons CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css">
</head>

<body>
    <!-- Top bar -->
    <nav class="navbar navbar-expand-lg bg-primary" data-bs-theme="dark">

        <div class="container-fluid">
            <a class="navbar-brand" href="#">PortMaster Database</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="#newGameEntry">New Game Entry</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#database">Database</a>
                    </li>
                </ul>
                <span id="gameCount" class="navbar-text me-3">
                    0 Games
                </span>
                <button class="btn btn-sm btn-light justify-self-end" id="theme-changer" type="button" title="Change Theme">
                    <i class="bi bi-sun-fill"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Content below the top bar -->
    <div class="container-fluid mt-4">
        <!-- Game Entry Section -->
        <div class="row">
            <div class="col-12 col-md-6 offset-md-3">
                <div id="newGameEntry" class="card">
                    <div class="card-body">
                        <h5 class="card-title">Add New Game</h5>
                        <form id="gameForm" class="form-inline">
                            <div class="mb-3 me-2">
                                <label for="gameName" class="me-2">Game Name:</label>
                                <input type="text" class="form-control" id="gameName" required>
                            </div>
                            <div class="mb-3 me-2">
                                <label for="gameURL" class="me-2">Game URL:</label>
                                <input type="url" class="form-control" id="gameURL" required>
                            </div>
                            <div class="mb-3">
                                <label for="gameComments" class="me-2">Comments:</label>
                                <textarea class="form-control" id="gameComments"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary ms-2">Add Game</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Table -->
        <div id="database" class="mt-4">
            <table id="gameTable" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Game Name</th>
                        <th>Comments</th>
                        <th>Status</th>
                        <th data-orderable="false">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Game data from Firebase will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Form edit template -->
        <form id="form-edit-template" class="form-inline d-none">
            <div class="mb-3">
                <label class="me-2">Game Name:</label>
                <div class="show-game-name">---</div>
            </div>
            <div class="mb-3">
                <label for="editGameComments" class="me-2">Comments:</label>
                <textarea class="form-control edit-game-comments"></textarea>
            </div>
            <div class="mb-3">
                <label for="editGameStatus" class="me-2">Status:</label>
                <select class="form-select edit-game-status">
                    <option value="Done">Done</option>
                    <option value="WIP">WIP</option>
                    <option value="Missing Requirements">Missing Requirements</option>
                </select>
            </div>
        </form>
    </div>

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.min.js" integrity="sha512-3dZ9wIrMMij8rOH7X3kLfXAzwtcHpuYpEgQg1OA4QAob1e81H8ntUQmQm3pBudqIoySO5j0tHN4ENzA6+n2r4w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- DataTables JS -->
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>
    <!-- Bootbox.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/6.0.0/bootbox.min.js" integrity="sha512-oVbWSv2O4y1UzvExJMHaHcaib4wsBMS5tEP3/YkMP6GmkwRJAa79Jwsv+Y/w7w2Vb/98/Xhvck10LyJweB8Jsw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <!-- Firestore (Firebase database) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Firebase configuration
		const firebaseConfig = {
			apiKey: "AIzaSyDaZcun82L8Y9ygM4YftjnVktfHR_RYa5k",
			authDomain: "portmaster-worksheet.firebaseapp.com",
			projectId: "portmaster-worksheet",
			storageBucket: "portmaster-worksheet.appspot.com",
			messagingSenderId: "446872253270",
			appId: "1:446872253270:web:26346a4a16ce4878279cf7"
		};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const gameForm = document.getElementById("gameForm");
        const gameName = document.getElementById("gameName");
        const gameURL = document.getElementById("gameURL");
        const gameComments = document.getElementById("gameComments");
        const gameCount = document.getElementById("gameCount");
        const gameTable = document.getElementById("gameTable");

        // Calling jQuery ready event, for further calls inside it
        $(document).ready(function() {
            // Instantiate the theme changer button behavior
            $('#theme-changer').on('click.changeTheme', function(event, wasTriggered) {
                const $button = $(this);
                const $iIcon = $button.children('i.bi');
                const $html = $('html');

                let theme = '';
                if (wasTriggered) {
                    theme = localStorage.getItem('theme') ?? 'light';
                } else {
                    theme = ($button.hasClass('btn-light')) ? ('dark') : ('light');
                }

                if (theme == 'dark') {
                    $button.removeClass('btn-light').addClass('btn-dark');
                    $iIcon.removeClass('bi-sun-fill').addClass('bi-moon-stars-fill');
                } else {
                    $button.removeClass('btn-dark').addClass('btn-light');
                    $iIcon.removeClass('bi-moon-stars-fill').addClass('bi-sun-fill');
                }
                $html.attr('data-bs-theme', theme);
                localStorage.setItem('theme', theme);
            }).trigger('click.changeTheme', true);

            // Initialize the DataTable.
            $('#gameTable').DataTable({
                pageLength: 50,
                autoWidth: false,
                columns: [
                    { "width": '35%' },
                    { "width": '50%' },
                    { "width": '10%' },
                    { "width": '5%' },
                ],
            });
        });

        function fetchGames() {
            db.collection("games").get().then((querySnapshot) => {
                let games = [];
                querySnapshot.forEach((doc) => {
                    games.push({
                        ...doc.data(),
                        id: doc.id
                    });
                });
                populateGameTable(games);
            });
        }

        function populateGameTable(games) {
            var table = $(gameTable).DataTable();

            // Clearing table, before populating it through jQuery DataTables API.
            table.clear().draw();

            games.forEach(game => {
                // Game name, also containing its URL as a link.
                let $gameNameDiv = $("<div />").html(
                    $('<a />').attr('href', game.url).html(game.name)
                );

                let comment = game.comment ?? game.comments;
                let status = game.status ?? 'Done';

                // Edit and delete buttons.
                let $divActions = $('<div />').addClass('btn-group btn-group-sm').attr('role', 'group').append(
                    $('<button />').addClass('btn btn-outline-primary edit').attr('title', 'Edit').html(
                        $('<i />').addClass('bi bi-pencil-fill')
                    )
                ).append(
                    $('<button />').addClass('btn btn-outline-danger delete').attr('title', 'Delete').html(
                        $('<i />').addClass('bi bi-trash3-fill')
                    )
                );

                // Adding table row through jQuery DataTables API.
                var rowNode = table.row.add([
                    $gameNameDiv[0].outerHTML,
                    comment,
                    status,
                    $divActions[0].outerHTML,
                ]).draw().node();
                var $tr = $(rowNode);

                $tr.find('button.edit').on('click', function() {
                    let $formEdit = $('#form-edit-template').clone().removeClass('d-none');
                    let $divGameName = $formEdit.find('.show-game-name');
                    let $textareaComments = $formEdit.find('.edit-game-comments');
                    let $selectStatus = $formEdit.find('.edit-game-status');

                    $divGameName.attr('id', 'showGameName').removeClass('show-game-name').html(game.name);
                    $textareaComments.attr('id', 'editGameComments').removeClass('edit-game-comments').val(comment);
                    $selectStatus.attr('id', 'editGameStatus').removeClass('edit-game-status').val(status);

                    bootbox.confirm({
                        title: 'Edit Game',
                        message: $formEdit,
                        buttons: {
                            confirm: {
                                label: 'Save',
                                className: 'btn-success'
                            },
                            cancel: {
                                label: 'Cancel',
                                className: 'btn-secondary'
                            }
                        },
                        animate: false,
                        callback: function (submit) {
                            if (submit) {
                                const $processingModal = showLoadingModal();

                                setTimeout(function() {
                                    $processingModal.modal('hide');

                                    const editedComment = $textareaComments.val();
                                    const editedStatus = $selectStatus.val();

                                    bootbox.alert({
                                        title: 'Info',
                                        message: `Comments: ${editedComment}<br />Status: ${editedStatus}<br />Game ID: ${game.id}<br /><br />Game saved successfully (?)`,
                                    });
                                    fetchGames();
                                }, 1000);
                            }
                        }
                    });
                });

                // Adding onclick event to the Delete button.
                $tr.find('button.delete').on('click', function() {
                    bootbox.confirm({
                        title: 'Confirmation',
                        message: 'Are you sure you want to delete this record?',
                        animate: false,
                        buttons: {
                            confirm: {
                                label: 'Yes',
                                className: 'btn-danger'
                            },
                            cancel: {
                                label: 'No',
                                className: 'btn-secondary'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                const $processingModal = showLoadingModal();

                                setTimeout(function() {
                                    const rowNumber = $(rowNode).index();
                                    deleteGame(game.id, rowNumber, function() {
                                        $processingModal.modal('hide');
                                        bootbox.alert({
                                            title: 'Info',
                                            message: 'Game deleted successfully.',
                                        });
                                    });
                                }, 1000);
                            }
                        }
                    });
                });
            });

            gameCount.textContent = `${games.length} Games`;
        }

        function showLoadingModal() {
            const $divSpinner = $('<div />').addClass('text-center').html(
                $('<div />').addClass('spinner-border').attr('role', 'status').html(
                    $('<span />').addClass('visually-hidden').html('Processing...')
                )
            ).append(
                $('<span />').addClass('ms-2').css('verticalAlign', 'super').html('Processing...')
            );
            return bootbox.dialog({
                message: $divSpinner,
                animate: false,
                closeButton: false
            });
        }

        function deleteGame(id, rowNumber, callback) {
            var table = $(gameTable).DataTable();

            db.collection("games").doc(id).delete().then(() => {
                // Deleting table row through jQuery DataTables API.
                table.row(rowNumber).remove().draw(false);
                if (callback) callback();
            });
        }

        gameForm.addEventListener("submit", function(e) {
            e.preventDefault();

            let gameData = {
                name: gameName.value,
                url: gameURL.value,
                comment: gameComments.value
            };

            // Check for duplicates
            db.collection("games").where("name", "==", gameData.name).get().then((querySnapshot) => {
                if (!querySnapshot.empty) {
                    alert("A game with this name already exists.");
                    return;
                } else {
                    db.collection("games").where("url", "==", gameData.url).get().then((querySnapshot) => {
                        if (!querySnapshot.empty) {
                            alert("A game with this URL already exists.");
                            return;
                        } else {
                            db.collection("games").add(gameData).then(() => {
                                gameName.value = "";
                                gameURL.value = "";
                                gameComments.value = "";
                                // Refetch games after adding to display the latest data
                                fetchGames();
                            });
                        }
                    });
                }
            });
        });

        // Fetch games when the page loads
        fetchGames();
    </script>

</body>

</html>